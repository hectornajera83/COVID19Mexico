---
title: "Análisis de robustez"
author: "Dr. Héctor Nájera"
date: "20 May 2020"
output: html_document
---

Las prevalencias ajustada provienen de un modelo bayesiano jerárquico robusto que regularmente da mejores resultados que los modelos comunes de máxima verosimilitud. Sin embargo, la naturaleza de los datos utilizados puede afectar la precisión de la estimación y sesgar las cifras reportadas. Con el fin de garantizar un mínimo de robustez de los resultados presentados, se hacieron análisis cuasi-experimentales (Comparar a dos grupos equivalentes) para tratar de reducir el efecto del modelo y la estructura de datos sobre los resultados. 

Estos análisis se hicieron con el paquete `MatchIt()` de **R**. Los análisis se hicieron para tres factores decisivos en el riesgo de fallecimiento de COVID-19: Obesidad, diabetes e hipertensión. El proceso consistió en estimar tres modelos cuasi-experimentales (análisis de vecinos más cercanos) para obtener un suubconjunto de datos de grupos cuasi-equivalentes. Después se calcularon efectos marginales para compararlos con los resultados del modelo bayesiano de prevalencia ajustada. Los resultados muestran que los resultados del modelo bayesiano son altamente confiables.  

## Estimaciones modelos de análisis causal {.tabset} 

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(foreign)
library(ggeffects)
library(jtools)
library(huxtable)
library(ggplot2)
library(haven)
library(fastDummies)
library(gganimate)
library(MatchIt)

D<-read_dta("COVID19.dta")
D1<-subset(D, D$resultado==1)



D1<-dummy_cols(D1, select_columns = c("obesidad","sector","diabetes","lastWeek","embarazo","intubado","asma", "tabaquismo", "inmusupr",
                                      "hipertension","renal_cronica","cardiovascular","habla_lengua_indig", "sexo"))
```



```{r echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE}
D.m<-D1[,c("death", "f_gap", 	"f_gap2", "sector_3"	,"sector_4", 	"sector_6", 	"sector_8", 	"sector_9", 	"sector_12", 	"sector_11", 	"edad2", 	"habla_lengua_indig_1", 	"obesidad_2", 	"cardiovascular_2", 	"renal_cronica_2", 	"tabaquismo_2", 	"hipertension_2", 	"inmusupr_2", 	"asma_2", 	"diabetes_2", 	"embarazo_2", 	"sexo_1", 	"lastWeek_1", 	"lastWeek_2", 	"lastWeek_3", "edad", "edad2")]

D.m<-D.m[complete.cases(D.m),]

match.out<-matchit(obesidad_2 ~ f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_1 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, D.m, method="nearest", distance="mahalanobis", caliper=.1)
MD<-match.data(match.out)

match.out<-matchit(diabetes_2 ~ f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_1 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + obesidad_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, D.m, method="nearest", distance="mahalanobis", caliper=.1)
MD.D<-match.data(match.out)

match.out<-matchit(habla_lengua_indig_1 ~ f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + diabetes_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + obesidad_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, D.m, method="nearest", distance="mahalanobis", caliper=.1)
MD.I<-match.data(match.out)

match.out<-matchit(hipertension_2 ~ f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + diabetes_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + habla_lengua_indig_1 + inmusupr_2 + asma_2 + obesidad_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, D.m, method="nearest", distance="mahalanobis", caliper=.1)
MD.H<-match.data(match.out)

#zelig(death ~ 1 + f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_1 + #cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + #lastWeek_3, data=MD, model="logit")
```

```{r echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE}
library(brms)
library(dplyr)

Model.BM<-brm(death ~ 1 + f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_1 + obesidad_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, data = MD, prior = c(set_prior("normal(0,10)", class="b"),
                                set_prior("student_t(3,0,5)", class="Intercept"),
                                set_prior("normal(0,1)", class="b", coef="sexo_1"),
                                set_prior("normal(0,1)", class="b", coef="embarazo_2"),
                                set_prior("normal(0,1)", class="b", coef="sector_3"),
                                set_prior("normal(0,1)", class="b", coef="sector_4"),
                                set_prior("normal(0,1)", class="b", coef="sector_6"),
                                set_prior("normal(0,1)", class="b", coef="sector_11"),
                                set_prior("normal(0,1)", class="b", coef="sector_12"),
                                set_prior("normal(0,1)", class="b", coef="sector_8"),
                                set_prior("normal(0,1)", class="b", coef="sector_9")),
 family = "bernoulli", chains=4, cores=4, iter = 1500, control = list(max_treedepth = 12))

save(Model.BM,file="Model.BM")

Model.BM.D<-brm(death ~ 1 + f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_1 + obesidad_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, data = MD.D, prior = c(set_prior("normal(0,10)", class="b"),
                                set_prior("student_t(3,0,5)", class="Intercept"),
                                set_prior("normal(0,1)", class="b", coef="sexo_1"),
                                set_prior("normal(0,1)", class="b", coef="embarazo_2"),
                                set_prior("normal(0,1)", class="b", coef="sector_3"),
                                set_prior("normal(0,1)", class="b", coef="sector_4"),
                                set_prior("normal(0,1)", class="b", coef="sector_6"),
                                set_prior("normal(0,1)", class="b", coef="sector_11"),
                                set_prior("normal(0,1)", class="b", coef="sector_12"),
                                set_prior("normal(0,1)", class="b", coef="sector_8"),
                                set_prior("normal(0,1)", class="b", coef="sector_9")),
 family = "bernoulli", chains=4, cores=4, iter = 1500, control = list(max_treedepth = 12))

save(Model.BM.D,file="Model.BM.D")

Model.BM.I<-brm(death ~ 1 + f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_1 + obesidad_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, data = MD.I, prior = c(set_prior("normal(0,10)", class="b"),
                                set_prior("student_t(3,0,5)", class="Intercept"),
                                set_prior("normal(0,1)", class="b", coef="sexo_1"),
                                set_prior("normal(0,1)", class="b", coef="embarazo_2"),
                                set_prior("normal(0,1)", class="b", coef="sector_3"),
                                set_prior("normal(0,1)", class="b", coef="sector_4"),
                                set_prior("normal(0,1)", class="b", coef="sector_6"),
                                set_prior("normal(0,1)", class="b", coef="sector_11"),
                                set_prior("normal(0,1)", class="b", coef="sector_12"),
                                set_prior("normal(0,1)", class="b", coef="sector_8"),
                                set_prior("normal(0,1)", class="b", coef="sector_9")),
 family = "bernoulli", chains=4, cores=4, iter = 1500, control = list(max_treedepth = 12))

save(Model.BM.I,file="Model.BM.I")

Model.BM.H<-brm(death ~ 1 + f_gap + f_gap2  + sector_3 + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_1 + obesidad_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, data = MD.H, prior = c(set_prior("normal(0,10)", class="b"),
                                set_prior("student_t(3,0,5)", class="Intercept"),
                                set_prior("normal(0,1)", class="b", coef="sexo_1"),
                                set_prior("normal(0,1)", class="b", coef="embarazo_2"),
                                set_prior("normal(0,1)", class="b", coef="sector_3"),
                                set_prior("normal(0,1)", class="b", coef="sector_4"),
                                set_prior("normal(0,1)", class="b", coef="sector_6"),
                                set_prior("normal(0,1)", class="b", coef="sector_11"),
                                set_prior("normal(0,1)", class="b", coef="sector_12"),
                                set_prior("normal(0,1)", class="b", coef="sector_8"),
                                set_prior("normal(0,1)", class="b", coef="sector_9")),
 family = "bernoulli", chains=4, cores=4, iter = 1200, control = list(max_treedepth = 12))

save(Model.BM.H,file="Model.BM.H")
```

### Obesidad

```{r echo=FALSE, warning=FALSE, message=FALSE}
load("Model.B")
load("Model.BM")
obesidad.m<-ggpredict(Model.B, terms = c("obesidad_2"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

obesidad.r<-ggpredict(Model.B, terms = c("obesidad_2"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .6,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))

obesidad.mM<-ggpredict(Model.BM, terms = c("obesidad_2"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

obesidad.rM<-ggpredict(Model.BM, terms = c("obesidad_2"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .6,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))

obesidad.m$riesgo<-"Medio"
obesidad.r$riesgo<-"Alto"
obesidad<-rbind(obesidad.m,obesidad.r)
obesidad$group<-"Datos completos"

obesidad.mM$riesgo<-"Medio"
obesidad.rM$riesgo<-"Alto"
obesidad.M<-rbind(obesidad.mM,obesidad.rM)
obesidad.M$group<-"Subconjunto comparable"


obesidad<-rbind(obesidad,obesidad.M)


obesidad$x<-ifelse(obesidad$x==1,"Sin Obesidad","Con Obesidad")

ggplot(obesidad, aes(x = x, y = predicted*100, colour=riesgo, group=riesgo)) +
  geom_point(position=position_dodge(width=.3)) +
  geom_pointrange(aes(ymin = conf.low*100, ymax = conf.high*100), fatten = 8, position=position_dodge(width=.3)) + labs(x="Condición de obesidad", y="Probabilidad fallecimiento (%). CI 95%", color = "Riesgo factores de salud") + 
   ylim(c(4,35)) + 
  theme_classic() +   scale_color_hue(l=40, c=90) + facet_grid(~group)
```

### Diabetes

```{r echo=FALSE, warning=FALSE, message=FALSE}
diabetes.m<-ggpredict(Model.B, terms = c("diabetes_2"), condition = c(tabaquismo_2 = .6,
                                                               obesidad_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

diabetes.r<-ggpredict(Model.B, terms = c("diabetes_2"), ci.lvl = 0.95, condition = c(tabaquismo_2 = .1,
                                                               obesidad_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               sexo_1 = .6,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))
load("Model.BM.D")

diabetes.mM<-ggpredict(Model.BM.D, terms = c("diabetes_2"), condition = c(tabaquismo_2 = .6,
                                                               obesidad_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

diabetes.rM<-ggpredict(Model.BM.D, terms = c("diabetes_2"), ci.lvl = 0.95, condition = c(tabaquismo_2 = .1,
                                                               obesidad_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               sexo_1 = .6,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))

diabetes.m$riesgo<-"Medio"
diabetes.r$riesgo<-"Alto"
diabetes<-rbind(diabetes.m,diabetes.r)
diabetes$group<-"Datos completos"

diabetes.mM$riesgo<-"Medio"
diabetes.rM$riesgo<-"Alto"
diabetes.M<-rbind(diabetes.mM,diabetes.rM)
diabetes.M$group<-"Subconjunto comparable"


diabetes<-rbind(diabetes,diabetes.M)

diabetes$x<-ifelse(diabetes$x==1,"Sin Diabetes","Con Diabetes")

ggplot(diabetes, aes(x = x, y = predicted*100, colour=riesgo, group=riesgo)) +
  geom_point(position=position_dodge(width=.3)) +
  geom_pointrange(aes(ymin = conf.low*100, ymax = conf.high*100), fatten = 8, position=position_dodge(width=.3)) + labs(x="Condición de diabetes", y="Probabilidad fallecimiento (%). CI 95%", color = "Riesgo factores de salud") + 
   ylim(c(4,45)) + 
  theme_classic() +   scale_color_manual(values=c("#d64161", "#6b5b95")) + facet_grid(~group)

```

### Hipertensión


```{r echo=FALSE, warning=FALSE, message=FALSE}
hipertension.m<-ggpredict(Model.B, terms = c("hipertension_2"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               obesidad_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

hipertension.r<-ggpredict(Model.B, terms = c("hipertension_2"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               obesidad_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               diabetes_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .6,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))

load("Model.BM.H")

hipertension.mM<-ggpredict(Model.BM.H, terms = c("hipertension_2"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               obesidad_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

hipertension.rM<-ggpredict(Model.BM.H, terms = c("hipertension_2"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               obesidad_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               diabetes_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .6,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))


hipertension.m$riesgo<-"Medio"
hipertension.r$riesgo<-"Alto"
hipertension<-rbind(hipertension.m,hipertension.r)
hipertension$group<-"Datos completos"

hipertension.mM$riesgo<-"Medio"
hipertension.rM$riesgo<-"Alto"
hipertension.M<-rbind(hipertension.mM,hipertension.rM)
hipertension.M$group<-"Subconjunto comparable"


hipertension<-rbind(hipertension,hipertension.M)

hipertension$x<-ifelse(hipertension$x==1,"Sin hipertensión","Con hipertensión")

ggplot(hipertension, aes(x = x, y = predicted*100, colour=riesgo, group=riesgo)) +
  geom_point(position=position_dodge(width=.3)) +
  geom_pointrange(aes(ymin = conf.low*100, ymax = conf.high*100), fatten = 8, position=position_dodge(width=.3)) + labs(x="Condición de hipertensión", y="Probabilidad fallecimiento (%). CI 95%", color = "Riesgo factores de salud") + 
   ylim(c(4,35)) + 
 theme_classic() + scale_color_manual(values=c("#484f4f", "#bd5734")) + facet_wrap(~group)

```



```{r echo=FALSE, warning=FALSE, message=FALSE, include=FALSE}
indigena.m<-ggpredict(Model.B, terms = c("habla_lengua_indig_1"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               obesidad_2=.6,
                                                               cardiovascular_2 = .6,
                                                               sexo_1 = .6,
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))


indigena.r<-ggpredict(Model.B, terms = c("habla_lengua_indig_1"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               obesidad_2= .1,
                                                               cardiovascular_2 = .1,
                                                               sexo = .6,
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))

load("Model.BM.I")

indigena.mM<-ggpredict(Model.BM.I, terms = c("habla_lengua_indig_1"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               obesidad_2=.6,
                                                               cardiovascular_2 = .6,
                                                               sexo_1 = .6,
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sector_3 = mean(D1$sector_3),
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))


indigena.rM<-ggpredict(Model.BM.I, terms = c("habla_lengua_indig_1"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               obesidad_2= .1,
                                                               cardiovascular_2 = .1,
                                                               sexo = .6,
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))

indigena.m$riesgo<-"Medio"
indigena.r$riesgo<-"Alto"
indigena<-rbind(indigena.m,indigena.r)
indigena$group<-"Datos completos"

indigena.mM$riesgo<-"Medio"
indigena.rM$riesgo<-"Alto"
indigena.M<-rbind(indigena.mM,indigena.rM)
indigena.M$group<-"Subconjunto comparable"

indigena<-rbind(indigena,indigena.M)


indigena$x<-ifelse(indigena$x==1,"Habla lengua indígena","No habla lengua indígena")

ggplot(indigena, aes(x = x, y = predicted*100, colour=riesgo, group=riesgo)) +
  geom_point(position=position_dodge(width=.3)) +
  geom_pointrange(aes(ymin = conf.low*100, ymax = conf.high*100), fatten = 8, position=position_dodge(width=.3)) + labs(x="Habla lengua indígena", y="Probabilidad fallecimiento (%). CI 95%", c) + 
   ylim(c(2,80)) + 
  theme_classic() +   scale_color_hue(l=20, c=76) + facet_grid(~group)
```



```{r eval=FALSE, include=FALSE}
library(MatchingFrontier)

D.m<-as.data.frame(D.m)

match.on <- colnames(D.m)[!(colnames(D.m) %in% c('death','obesidad_2'))]

makeFrontier(dataset = D.m, treatment = "obesidad_2", match.on = match.on)


```



```{r eval=FALSE, include=FALSE}
library(survival)
library(survminer)

D1$survobj<-with(D1, Surv(edad, death == 1))

km.as.one <- survfit(survobj ~ 1 + f_gap + f_gap2  + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad2 + habla_lengua_indig_2 + obesidad_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3 , data = D1, conf.type = "log-log")

plot(km.as.one)

res.cox1 <- coxph(survobj ~ f_gap + f_gap2  + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad2 + habla_lengua_indig_2 + obesidad_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3, data =  D1)
res.cox1

(res.zph1 <- cox.zph(res.cox1))
a<-ggcoxzph(res.zph1)

ggsurvplot(km.as.one, conf.int = TRUE, legend.labs=c("Sin obesidad", "Con obesidad"),
           ggtheme = theme_minimal())


```

Para mayor información sobre este tipo de análisis se recomienda <a href="https://r.iq.harvard.edu/docs/matchit/2.4-20/matchit.pdf"> leer este texto.</a>  



