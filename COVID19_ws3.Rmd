---
title: "Covid19-México."
output: 
  html_document:
    orientation: columns
    vertical_layout: fill
    logo: logo2.png
    bootstrap_version: 4+3
    theme: cosmo
---

```{r setup, include=FALSE}
library(flexdashboard)
library(foreign)
library(ggeffects)
library(jtools)
library(huxtable)
library(ggplot2)
library(haven)
library(fastDummies)

D<-read_dta("COVID19.dta")
D1<-subset(D, D$resultado==1)



D1<-dummy_cols(D1, select_columns = c("obesidad","sector","diabetes","lastWeek","embarazo","intubado","asma", "tabaquismo", "inmusupr",
                                      "hipertension","renal_cronica","cardiovascular","habla_lengua_indig", "sexo"))

D1[,51:94]<-lapply(D1[,51:94], function(x) ifelse(x==0,.000000001,1))

```

```{r echo=FALSE}
load("Model.B")
```

## Probabilidad (prevalencia) ajustada: sector y estado {.tabset} 

Esta sección muestra la (<a href="https://hectornajera83.github.io/COVID19Mexico/Notas.html"> prevalencia ajustada</a>) de fallecimientos según distintas condiciones del sistema de salud y por estado. A diferencia de la  (<a href="https://hectornajera83.github.io/COVID19Mexico/COVID19_ws1.html"> prevalencia cruda</a>), se trata de estimaciones que permiten hacer conclusiones más robustas sobre los factores de riesgo de fallecimiento por COVID-19.

Todas las gráficas reconocen la incertidumbre de la estimación y se incluyen (<a href="https://en.wikipedia.org/wiki/Credible_interval" target="_blank">intervalos creíbles</a>) al 95% . Esto signfica que, con una probabilidad de 95%, el valor observado se ubica en el rango mostrado en la gráfica. 

Se recomienda leer la *Nota: Prevalencia ajustada*. 

### Sector


```{r echo=FALSE, warning=FALSE, message=FALSE}
sector.3<-ggpredict(Model.B, terms = c("sector_3 [1]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.4<-ggpredict(Model.B, terms = c("sector_4 [1]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.6<-ggpredict(Model.B, terms = c("sector_6 [1]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.8<-ggpredict(Model.B, terms = c("sector_8 [1]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_4 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.9<-ggpredict(Model.B, terms = c("sector_9 [1]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_4 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.11<-ggpredict(Model.B, terms = c("sector_11 [1]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_4 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.12<-ggpredict(Model.B, terms = c("sector_12 [1]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_4 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.0<-ggpredict(Model.B, terms = c("sector_9 [0]"), condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .6,
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_12 = .1,
                                                               sector_11 = .1,
                                                               sector_4 = .1,
                                                               sexo_1 = .5,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.3r<-ggpredict(Model.B, terms = c("sector_3 [1]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))


sector.4r<-ggpredict(Model.B, terms = c("sector_4 [1]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.6r<-ggpredict(Model.B, terms = c("sector_6 [1]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_4 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.8r<-ggpredict(Model.B, terms = c("sector_8 [1]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_4 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.9r<-ggpredict(Model.B, terms = c("sector_9 [1]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_4 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.11r<-ggpredict(Model.B, terms = c("sector_11 [1]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_4 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.12r<-ggpredict(Model.B, terms = c("sector_12 [1]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_4 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

sector.0r<-ggpredict(Model.B, terms = c("sector_9 [0]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               obesidad_2 = .1,
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .5,
                                                               sector_3 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_12 = .1,
                                                               sector_11 = .1,
                                                               sector_4 = .1,
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))



sector.p<-rbind(sector.3,sector.0,sector.4,sector.6,sector.8,sector.9,sector.11,sector.12)
sector.p<-rbind(sector.p,sector.3r,sector.0r,sector.4r,sector.6r,sector.8r,sector.9r,sector.11r,sector.12r)
sector.p$Institucion <- c("Estatal", "OTRO", "IMSS", "ISSSTE", "PEMEX", "PRIVADA", "SEMAR", "SSA","Estatal","OTRO", "IMSS", "ISSSTE", "PEMEX", "PRIVADA", "SEMAR", "SSA")
sector.p$riesgo<-rep(c("Medio","Alto"),each=8)

ggplot(sector.p, aes(x = reorder(Institucion, predicted), y = predicted*100, colour=riesgo, group=riesgo)) +
  geom_point(position=position_dodge(width=.3)) +
  geom_pointrange(aes(ymin = conf.low*100, ymax = conf.high*100), fatten = 8, position=position_dodge(width=.3)) + labs(x="Sector Salud", y="Probabilidad fallecimiento (%). CI 95%", color = "Riesgo factores de salud") + 
   ylim(c(0,50))  +
  theme_classic() +   scale_color_hue(l=40, c=70) + theme(legend.position = "bottom") 
```

### Entidad 

```{r echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}
Model<- glm(death ~ 1 + f_gap + f_gap2  + sector_4 + sector_6 + sector_8 + sector_9 + sector_12 + sector_11  + edad + edad2 + habla_lengua_indig_2 + obesidad_2 + cardiovascular_2 + renal_cronica_2 + tabaquismo_2 + hipertension_2 + inmusupr_2 + asma_2 + diabetes_2 + embarazo_2 + sexo_1 + lastWeek_1 + lastWeek_2 + lastWeek_3 + as.factor(entidad_res), data = D1, family = "binomial", trace = TRUE, epsilon = 1e-10)
```

```{r echo=FALSE, warning=FALSE, message=FALSE}
entidad.m<-ggpredict(Model, terms = c("entidad_res [1:32]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               obesidad_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               embarazo_2 = .1,
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

entidad.r<-ggpredict(Model, terms = c("entidad_res [1:32]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               obesidad_2= .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_1 = .1,
                                                               embarazo_2 = .1,
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

entidad.m$riesgo<-"Medio"
entidad.r$riesgo<-"Alto"
entidad.p<-rbind(entidad.m,entidad.r)
entidad.p<-entidad.p[order(entidad.p$x),]

entidad.p$Entidad<-rep(c("Aguascalientes","Baja California","Baja California Sur","Campeche","Coahuila","Colima",
                      "Chiapas","Chihuahua","Ciudad de México","Durango","Guanajuato","Guerrero","Hidalgo","Jalisco",
                       "México","Michoacán", "Morelos","Nayarit","Nuevo León", "Oaxaca","Puebla","Querétaro","Quintana Roo",
                       "San Luis Potosí", "Sinaloa","Sonora", "Tabasco", "Tamaulipas","Tlaxcala","Veracruz","Yucatán", "Zacatecas"), each=2)


ggplot(entidad.p, aes(x = reorder(Entidad, predicted), y = predicted*100, colour=riesgo, group=riesgo)) +
  geom_point(position=position_dodge(width=.3)) +
  geom_pointrange(aes(ymin = conf.low*100, ymax = conf.high*100), fatten = 8, position=position_dodge(width=.3)) + labs(x="Entidad", y="Probabilidad fallecimiento (%). CI 95%", color = "Riesgo factores de salud") + 
   ylim(c(0,65))   +
  theme_classic() +  theme(axis.text.x = element_text(angle = 90, hjust = 1), legend.position="bottom") + scale_color_hue(l=15, c=70)

```


### Tiempo atención

```{r echo=FALSE, warning=FALSE, message=FALSE}
tiempo.m<-ggpredict(Model.B, terms = c("f_gap [0:7]"), ci.lvl = 0.95, condition = c(tabaquismo_2 = .6,
                                                               diabetes_2= .6,
                                                               obesidad_2= .6,
                                                               cardiovascular_2 = .6,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .6,
                                                               hipertension_2 = .6,
                                                               inmusupr_2 = .6,
                                                               asma_2 = .6,
                                                               sexo_1 = .5,
                                                               sector_4 = mean(D1$sector_4),
                                                               sector_6 = mean(D1$sector_6),
                                                               sector_8 = mean(D1$sector_8),
                                                               sector_9 = mean(D1$sector_9),
                                                               sector_11 = mean(D1$sector_11),
                                                               sector_12 = mean(D1$sector_12),
                                                               lastWeek_1 = mean(D1$lastWeek_1),
                                                               lastWeek_2 = mean(D1$lastWeek_2),
                                                               lastWeek_3 = mean(D1$lastWeek_3)))

tiempo.r<-ggpredict(Model.B, terms = c("f_gap [0:7]"), ci.lvl = 0.90, condition = c(tabaquismo_2 = .1,
                                                               diabetes_2= .1,
                                                               obesidad_2 = .1,
                                                               cardiovascular_2 = .1,
                                                               habla_lengua_indig_1 = mean(D1$habla_lengua_indig_1),
                                                               embarazo_2 = mean(D1$embarazo_2),
                                                               renal_cronica_2 = .1,
                                                               hipertension_2 = .1,
                                                               inmusupr_2 = .1,
                                                               asma_2 = .1,
                                                               sexo_2 = .5,
                                                               sector_4 = .1,
                                                               sector_6 = .1,
                                                               sector_8 = .1,
                                                               sector_9 = .1,
                                                               sector_11 = .1,
                                                               sector_12 = .1,
                                                               lastWeek_1 = .1,
                                                               lastWeek_2 = .1,
                                                               lastWeek_3 = .1))


tiempo.m$riesgo<-"Medio"
tiempo.r$riesgo<-"Alto"
tiempo.p<-rbind(tiempo.m,tiempo.r)


ggplot(data=tiempo.p, aes(x, predicted*100, group = riesgo)) + geom_ribbon(aes(ymin = conf.low*100, ymax = conf.high*100, fill=riesgo),  alpha=.6) + labs(x = "Días desde el inicio de síntomas hasta la atención", y = "Probabilidad de fallecimiento (%). 95% CI") + ylim(c(0,41)) + geom_line() + theme_classic() + theme(legend.position="bottom") + labs(fill = "Riesgo factores de salud") 
```

### Descriptivo tiempo de atención

```{r message=FALSE, warning=FALSE, echo=FALSE}
library(gganimate)

p <- ggplot(D1, aes(f_gap)) + geom_histogram(bins=25, color="#457D7E", fill="#307D7E")   + theme_classic() + labs(x="Brecha inicio de síntomas - atención", y="Casos diganosticados") + xlim(c(0,25)) 
p<-p +  transition_states(f_gap, wrap = FALSE) +
  shadow_mark()
animate(p, renderer = gifski_renderer(), fps=80, end_pause = 40)
```



### Nota: Probabilidad ajustada

#### Significado e interpretación

La probabilidad ajustada es la proporción de fallecimientos atribuibles a cierta característica (por ejemplo, obesidad) después de controlar por ciertos factores en un modelo estadístico. En el caso más simple, el control se hace a los valores promedio de los otros factores. En los casos más complicados el ajuste se hace a valores específicos. Por ejemplo, la probabilidad de Fallecimiento para gente con obesidad para la población hipertensa, con diabetes, etc. 

Estos datos se interpretan de la siguiente manera. Considere a dos grupos de personas, uno con y otro sin diabetes, con probabilidades ajustadas de 25% y 15%, respectivamente. Esto significa que -en promedio- el efecto de diabetes sobre la probabilidad de Fallecimiento es de 10%. En otras palabras, las personas con diabetes tienen 10% más riesgo de morir que las que no tienen diabetes. 

#### **Significado de riesgo medio y alto**

Riesgo medio: Es la probabilidad de Fallecimiento atribuible para la característica en cuestión -e.g. diabetes- considerando las otras características a sus valores promedio. Es decir, es la probabilidad de fallecimiento para diabéticos y no diabéticos con valores promedio de edad, padecimientos, lugar de residencia, hospital de atención, etc. Es decir, el riesgo medio trata de aproximar la probabilidad de morir para una persona adulta "normal o típica".

Riesgo alto: Es la probabilidad de fallecimiento atribuible para la característica -e.g. diabetes- considerando que sus otras características -principalmente de salud- son de riesgo. Es decir, es la probabilidad de fallecimiento para diabéticos y no diabéticos que además tienen alto riesgo de enfermedad cardiovascular, renal crónica, obesidad, etc. No se trata, de la población típica en México.

#### **Método para cálculo de probabilidades**

Las probabilidades se obtienen en dos pasos:

* Estimación de modelo bayesiano de regresión binaria. Para la estimación se usaron los siguientes programas:

Rstan: 

Stan Development Team (2018). RStan: the R interface to Stan. R package version 2.18.2. http://mc-stan.org/

El paquete `brms()` de R: 

Paul-Christian Bürkner (2017). brms: An R Package for Bayesian Multilevel Models Using Stan. Journal of Statistical Software, 80(1), 1-28. doi:10.18637/jss.v080.i01

* Estimación de probabilidades a partir de los resultados del modelo.

Los paquetes `ggpredict()` de R. Con auxilio de `ggplot2()`. 

Lüdecke D (2018). “ggeffects: Tidy Data Frames of Marginal Effects from Regression Models.” _Journal of Open Source Software_, *3*(26), 772.
doi: 10.21105/joss.00772 (URL: http://doi.org/10.21105/joss.00772).

H. Wickham. ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York, 2016.

* Datos

Los datos se actualizan diariamente con información oficial de: https://datos.gob.mx/busca/dataset/informacion-referente-a-casos-covid-19-en-mexico
